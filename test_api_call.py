#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
æµ‹è¯•APIè°ƒç”¨
"""
import httpx
import json


def test_api_call():
    """æµ‹è¯•è°ƒç”¨æœ¬åœ°APIæœåŠ¡"""
    url = "http://localhost:28889/v1/chat/completions"
    
    payload = {
        "model": "claude-4-sonnet",
        "messages": [
            {"role": "user", "content": "ä½ å¥½ï¼Œè¯·ä»‹ç»ä¸€ä¸‹ä½ è‡ªå·±"}
        ],
        "stream": True
    }
    
    headers = {
        "Content-Type": "application/json",
        "Authorization": "Bearer test123"
    }
    
    print("=" * 80)
    print("ğŸ§ª æµ‹è¯•APIè°ƒç”¨")
    print("=" * 80)
    print(f"ğŸ“¤ è¯·æ±‚URL: {url}")
    print(f"ğŸ”‘ Authorization: {headers.get('Authorization')}")
    print(f"ğŸ“ è¯·æ±‚payload:")
    print(json.dumps(payload, indent=2, ensure_ascii=False))
    print("=" * 80)
    
    try:
        with httpx.Client(timeout=30.0) as client:
            with client.stream("POST", url, json=payload, headers=headers) as response:
                print(f"\nğŸ“¥ å“åº”çŠ¶æ€ç : {response.status_code}")
                print(f"ğŸ“‹ å“åº”å¤´:")
                for key, value in response.headers.items():
                    print(f"   {key}: {value}")
                
                print(f"\nğŸ“„ æµå¼å“åº”å†…å®¹:")
                print("-" * 80)
                
                for line in response.iter_lines():
                    if line.strip():
                        print(line)
                
                print("-" * 80)
                
    except httpx.ConnectError as e:
        print(f"\nâŒ è¿æ¥å¤±è´¥: {e}")
        print("âš ï¸ è¯·ç¡®ä¿æœåŠ¡å™¨æ­£åœ¨è¿è¡Œ: uv run python server.py")
    except Exception as e:
        print(f"\nâŒ è¯·æ±‚å¤±è´¥: {e}")
        import traceback
        traceback.print_exc()


if __name__ == "__main__":
    test_api_call()

